<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.solbox.api.dao.MainDashboardDao">
    <select id="getMainDashboard" resultType="hashMap">
        SELECT custom, gf_url, IFNULL(gf_status, '') AS gf_status
        , CASE WHEN live_stream_sum = 0 THEN 1 WHEN live_stream_sum IS NULL THEN '' ELSE 0 END AS live_stream_status
        FROM kt_md_custom mc LEFT JOIN (
            SELECT sp_comp_name, gf_status
            FROM svcdb.kt_svc c INNER JOIN kt_gf_mon gm ON c.svc_name=gm.service
            ) gf ON mc.custom=gf.sp_comp_name LEFT JOIN (
            SELECT z.customer, SUM(z.cnt) AS live_stream_sum
            FROM (
            SELECT customer, CASE WHEN mon_status = 'OK' || mon_status = 'RECOVERY' THEN 0 ELSE 1 END AS cnt
            FROM strmondb.t_stream_mon
            WHERE telco_gubun = 'KT'
            AND deleted_yn='N'
            ) z
            GROUP BY z.customer
            ) stream ON mc.custom=stream.customer
    </select>
</mapper>